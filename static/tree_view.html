<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„äº§æ¶æ„æ ‘çŠ¶å›¾</title>
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- å¼•å…¥jqueryåº“ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- å¼•å…¥è‡ªå®šä¹‰æ ‘çŠ¶å›¾æ ·å¼å’Œè„šæœ¬ -->
    <style>
        /* è‡ªå®šä¹‰æ ‘çŠ¶å›¾æ ·å¼ */
        .tree {
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .tree ul {
            list-style-type: none;
            padding-left: 20px;
        }
        
        .tree li {
            margin: 5px 0;
        }
        
        .tree-node {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            min-width: 200px;
        }
        
        .tree-node:hover {
            background-color: #f0f0f0;
        }
        
        .tree-node.collapsed::before {
            content: '+ ';
            font-weight: bold;
            color: #667eea;
        }
        
        .tree-node.expanded::before {
            content: '- ';
            font-weight: bold;
            color: #667eea;
        }
        
        .tree-node.leaf::before {
            content: 'â€¢ ';
            font-weight: bold;
            color: #667eea;
        }
        
        .node-icon {
            margin-right: 5px;
        }
        
        .node-info {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
    </style>
    <script>
        // è‡ªå®šä¹‰æ ‘çŠ¶å›¾åŠŸèƒ½
        $(document).ready(function() {
            // æ ‘èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
            $(document).on('click', '.tree-node', function() {
                var $this = $(this);
                var $children = $this.next('ul');
                
                if ($children.length > 0) {
                    $children.toggle();
                    if ($this.hasClass('collapsed')) {
                        $this.removeClass('collapsed').addClass('expanded');
                    } else {
                        $this.removeClass('expanded').addClass('collapsed');
                    }
                }
            });
        });
        
        // æ¸²æŸ“æ ‘çŠ¶å›¾
        function renderTree(data, containerId) {
            var container = document.getElementById(containerId);
            var treeHtml = buildTreeHtml(data);
            container.innerHTML = treeHtml;
        }
        
        // æ„å»ºæ ‘çŠ¶å›¾HTML
        function buildTreeHtml(node) {
            var html = '';
            
            if (node.children && node.children.length > 0) {
                html += '<ul>';
                node.children.forEach(function(child) {
                    var nodeClass = child.children && child.children.length > 0 ? 'tree-node collapsed' : 'tree-node leaf';
                    var icon = child.icon || 'ğŸ“';
                    var info = child.info || '';
                    
                    html += '<li>';
                    html += '<div class="' + nodeClass + '">';
                    html += '<span class="node-icon">' + icon + '</span>';
                    html += '<span class="node-name">' + child.name + '</span>';
                    if (info) {
                        html += '<span class="node-info">' + info + '</span>';
                    }
                    html += '</div>';
                    html += buildTreeHtml(child);
                    html += '</li>';
                });
                html += '</ul>';
            }
            
            return html;
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .tree-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        #assetTree {
            min-height: 500px;
        }

        /* èŠ‚ç‚¹æ ·å¼ */
        .ztree li span.button.node_name {
            font-size: 14px;
        }

        /* èµ„äº§ç±»å‹å›¾æ ‡é¢œè‰² */
        .domain-node { color: #1890ff; }
        .ip-node { color: #52c41a; }
        .port-node { color: #fa8c16; }
        .service-node { color: #722ed1; }
        .directory-node { color: #eb2f96; }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: bold;
            color: #555;
        }

        input[type="text"], select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }

        button {
            padding: 8px 16px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #40a9ff;
        }

        button:active {
            background-color: #096dd9;
        }

        /* ç»“æœç»Ÿè®¡æ ·å¼ */
        .stats-panel {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            background-color: #f0f2f5;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* è¿”å›é¦–é¡µæŒ‰é’® */
        .back-home {
            text-align: center;
            margin-top: 20px;
        }

        .back-home a {
            display: inline-block;
            padding: 10px 20px;
            background-color: #52c41a;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .back-home a:hover {
            background-color: #73d13d;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="text"], select {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>èµ„äº§æ¶æ„æ ‘çŠ¶å›¾</h1>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="control-group">
                <div class="form-group">
                    <label for="targetInput">ç›®æ ‡åœ°å€</label>
                    <input type="text" id="targetInput" placeholder="è¯·è¾“å…¥ç›®æ ‡åŸŸåæˆ–IP">
                </div>
                <button id="loadTreeBtn">åŠ è½½æ ‘çŠ¶å›¾</button>
                <button id="expandAllBtn">å±•å¼€å…¨éƒ¨</button>
                <button id="collapseAllBtn">æ”¶èµ·å…¨éƒ¨</button>
            </div>
        </div>

        <!-- ç»“æœç»Ÿè®¡ -->
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="domainCount">0</span>
                    <span class="stat-label">åŸŸåæ•°é‡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="ipCount">0</span>
                    <span class="stat-label">IPæ•°é‡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="portCount">0</span>
                    <span class="stat-label">å¼€æ”¾ç«¯å£</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="dirCount">0</span>
                    <span class="stat-label">ç›®å½•æ•°é‡</span>
                </div>
            </div>
        </div>

        <!-- æ ‘çŠ¶å›¾å®¹å™¨ -->
        <div class="tree-container">
            <ul id="assetTree" class="ztree"></ul>
        </div>

        <!-- è¿”å›é¦–é¡µ -->
        <div class="back-home">
            <a href="index.html">è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        var collectedData = {};

        // åˆå§‹åŒ–é¡µé¢
        $(document).ready(function() {
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            $("#loadTreeBtn").click(function() {
                var target = $("#targetInput").val().trim();
                if (target) {
                    loadAssetTree(target);
                } else {
                    alert("è¯·è¾“å…¥ç›®æ ‡åœ°å€");
                }
            });

            $("#expandAllBtn").click(function() {
                $("#assetTree").find(".tree-node.collapsed").each(function() {
                    $(this).click();
                });
            });

            $("#collapseAllBtn").click(function() {
                $("#assetTree").find(".tree-node.expanded").each(function() {
                    $(this).click();
                });
            });

            // æŒ‰ä¸‹å›è½¦é”®åŠ è½½æ ‘çŠ¶å›¾
            $("#targetInput").keypress(function(e) {
                if (e.which == 13) {
                    $("#loadTreeBtn").click();
                }
            });
        });

        // ä»åç«¯åŠ è½½èµ„äº§æ•°æ®
        function loadAssetTree(target) {
            $.ajax({
                url: "/api/get_result",
                type: "GET",
                data: { target: target },
                dataType: "json",
                beforeSend: function() {
                    $("#loadTreeBtn").text("åŠ è½½ä¸­...").prop("disabled", true);
                },
                success: function(data) {
                    if (data.success) {
                        collectedData = data.data;
                        // å¤„ç†æ•°æ®ç”Ÿæˆæ ‘èŠ‚ç‚¹
                        var treeData = processDataToCustomTree(collectedData);
                        // ä½¿ç”¨è‡ªå®šä¹‰æ ‘çŠ¶å›¾æ¸²æŸ“
                        renderTree({ children: treeData }, "assetTree");
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateStats(collectedData);
                    } else {
                        alert("åŠ è½½å¤±è´¥: " + data.message);
                    }
                },
                error: function() {
                    alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç›®æ ‡åœ°å€æ˜¯å¦æ­£ç¡®");
                },
                complete: function() {
                    $("#loadTreeBtn").text("åŠ è½½æ ‘çŠ¶å›¾").prop("disabled", false);
                }
            });
        }

        // å°†æ”¶é›†åˆ°çš„æ•°æ®è½¬æ¢ä¸ºè‡ªå®šä¹‰æ ‘èŠ‚ç‚¹ç»“æ„
        function processDataToCustomTree(data) {
            var nodes = [];
            var rootName = data.target;

            // åˆ›å»ºæ ¹èŠ‚ç‚¹
            var rootNode = {
                name: rootName,
                icon: data.is_ip ? 'ğŸŒ' : 'ğŸ“',
                children: []
            };

            // å¤„ç†IPèŠ‚ç‚¹
            if (data.ips && data.ips.length > 0) {
                data.ips.forEach(function(ip) {
                    var ipNode = {
                        name: ip,
                        icon: 'ğŸŒ',
                        children: []
                    };

                    // å¤„ç†å¼€æ”¾ç«¯å£
                    if (data.open_ports && data.open_ports.length > 0) {
                        data.open_ports.forEach(function(portInfo) {
                            if (portInfo.ip === ip) {
                                var serviceName = "unknown";
                                // æŸ¥æ‰¾å¯¹åº”çš„HTTPæœåŠ¡ä¿¡æ¯
                                if (data.http_service_info && data.http_service_info[ip] && data.http_service_info[ip][portInfo.port]) {
                                    serviceName = data.http_service_info[ip][portInfo.port].service;
                                }
                                
                                var portNode = {
                                    name: "ç«¯å£: " + portInfo.port,
                                    icon: 'ğŸ”Œ',
                                    info: serviceName,
                                    children: []
                                };

                                // å¤„ç†ç›®å½•ä¿¡æ¯
                                if (data.directories && data.directories.length > 0) {
                                    data.directories.forEach(function(dirInfo) {
                                        // ä»URLä¸­è§£æå‡ºIPå’Œç«¯å£
                                        var url = dirInfo.url;
                                        var urlParts = new URL(url);
                                        var dirIp = urlParts.hostname;
                                        var dirPort = urlParts.port;
                                        if (!dirPort) {
                                            dirPort = urlParts.protocol === 'https:' ? 443 : 80;
                                        }
                                        
                                        if (dirIp === ip && dirPort == portInfo.port) {
                                            portNode.children.push({
                                                name: "ç›®å½•: " + dirInfo.path,
                                                icon: 'ğŸ“‚',
                                                info: dirInfo.status_code
                                            });
                                        }
                                    });
                                }
                                
                                ipNode.children.push(portNode);
                            }
                        });
                    }
                    
                    rootNode.children.push(ipNode);
                });
            }

            // å¤„ç†å­åŸŸåèŠ‚ç‚¹
            if (data.subdomains && data.subdomains.length > 0) {
                data.subdomains.forEach(function(subdomainInfo) {
                    var subdomainNode = {
                        name: subdomainInfo.subdomain,
                        icon: 'ğŸ“',
                        children: []
                    };

                    // å¤„ç†å­åŸŸåçš„IP
                    if (subdomainInfo.ips && subdomainInfo.ips.length > 0) {
                        subdomainInfo.ips.forEach(function(ip) {
                            var subIpNode = {
                                name: ip,
                                icon: 'ğŸŒ',
                                children: []
                            };

                            // æŸ¥æ‰¾è¯¥IPçš„å¼€æ”¾ç«¯å£
                            if (data.open_ports && data.open_ports.length > 0) {
                                data.open_ports.forEach(function(portInfo) {
                                    if (portInfo.ip === ip) {
                                        var serviceName = "unknown";
                                        if (data.http_service_info && data.http_service_info[ip] && data.http_service_info[ip][portInfo.port]) {
                                            serviceName = data.http_service_info[ip][portInfo.port].service;
                                        }
                                        
                                        var subPortNode = {
                                            name: "ç«¯å£: " + portInfo.port,
                                            icon: 'ğŸ”Œ',
                                            info: serviceName,
                                            children: []
                                        };

                                        // æŸ¥æ‰¾è¯¥IP:ç«¯å£çš„ç›®å½•
                                        if (data.directories && data.directories.length > 0) {
                                            data.directories.forEach(function(dirInfo) {
                                                var url = dirInfo.url;
                                                var urlParts = new URL(url);
                                                var dirIp = urlParts.hostname;
                                                var dirPort = urlParts.port;
                                                if (!dirPort) {
                                                    dirPort = urlParts.protocol === 'https:' ? 443 : 80;
                                                }
                                                
                                                if (dirIp === ip && dirPort == portInfo.port) {
                                                    subPortNode.children.push({
                                                        name: "ç›®å½•: " + dirInfo.path,
                                                        icon: 'ğŸ“‚',
                                                        info: dirInfo.status_code
                                                    });
                                                }
                                            });
                                        }
                                        
                                        subIpNode.children.push(subPortNode);
                                    }
                                });
                            }
                            
                            subdomainNode.children.push(subIpNode);
                        });
                    }
                    
                    rootNode.children.push(subdomainNode);
                });
            }

            return [rootNode];
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(data) {
            // è®¡ç®—åŸŸåæ•°é‡
            var domainCount = data.subdomains ? data.subdomains.length + (data.is_ip ? 0 : 1) : (data.is_ip ? 0 : 1);
            // è®¡ç®—IPæ•°é‡
            var ipCount = new Set();
            if (data.ips) {
                data.ips.forEach(ip => ipCount.add(ip));
            }
            if (data.subdomain_ips) {
                Object.values(data.subdomain_ips).forEach(ips => {
                    ips.forEach(ip => ipCount.add(ip));
                });
            }
            // è®¡ç®—å¼€æ”¾ç«¯å£æ•°é‡
            var portCount = 0;
            if (data.open_ports) {
                Object.values(data.open_ports).forEach(ports => {
                    portCount += ports.length;
                });
            }
            // è®¡ç®—ç›®å½•æ•°é‡
            var dirCount = 0;
            if (data.directories) {
                Object.values(data.directories).forEach(ipPorts => {
                    Object.values(ipPorts).forEach(dirs => {
                        dirCount += dirs.length;
                    });
                });
            }

            // æ›´æ–°UI
            $("#domainCount").text(domainCount);
            $("#ipCount").text(ipCount.size);
            $("#portCount").text(portCount);
            $("#dirCount").text(dirCount);
            $("#statsPanel").show();
        }
    </script>
</body>
</html>